name: 🛡️ Template Validation

on:
  push:
    branches: [ main, develop ]
    paths:
      - '**/*.template'
      - 'validate-templates.js'
      - '.github/workflows/validate-templates.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**/*.template'
      - 'validate-templates.js'
      - '.github/workflows/validate-templates.yml'

jobs:
  validate:
    name: Validate Template Variables
    runs-on: ubuntu-latest

    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4

    - name: 📦 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        registry-url: 'https://npm.pkg.github.com'
        scope: '@mvp-kit'

    - name: 🔑 Configure GitHub packages
      run: |
        echo "@mvp-kit:registry=https://npm.pkg.github.com" >> ~/.npmrc
        echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" >> ~/.npmrc

    - name: 🔍 Validate templates
      run: npx @mvp-kit/template-validator core

    - name: ✅ Validation passed
      if: success()
      run: |
        echo "🎉 All templates use only approved variables!"
        echo "✅ Template validation successful"

    - name: ❌ Validation failed
      if: failure()
      run: |
        echo "💥 Template validation failed!"
        echo "🔧 Fix unauthorized variables before merging"
        echo "📋 Allowed: {{projectName}}, {{projectDescription}}, {{domainName}}, {{packageManager}}, {{packageManagerVersion}}"
        exit 1